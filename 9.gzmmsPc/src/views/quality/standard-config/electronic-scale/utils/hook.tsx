import { ElOption, ElSelect } from "element-plus";
import type { PaginationProps } from "@pureadmin/table";
import { withKeys } from "vue";
import { getInstMapApi } from "@/api/quality/common";
import { getPlaceListHooks, unitListHooks } from "@/hooks/index";

export function useList(search: () => void) {
  const { placeList } = getPlaceListHooks();
  const { unitList } = unitListHooks();
  /** Ë°®Ê†ºÂàÜÈ°µÈÖçÁΩÆ */
  const pagination = reactive<PaginationProps>({
    total: 0,
    pageSize: 10,
    currentPage: 1,
    background: true,
    pageSizes: [10, 20, 40, 50],
  });

  /** Ë°®ÂçïÊï∞ÊçÆ */
  const formData = ref({
    name: "", // ÂêçÁß∞
    inst_type_no: "", // ÂûãÂè∑
  });

  /** Ë°®Ê†ºÂàóÈÖçÁΩÆ */
  const columns: TableColumnList = [
    {
      label: "ÊéíÂ∫èÁºñÂè∑",
      prop: "sort",
      align: "center",
    },
    {
      label: "‰ΩøÁî®Âú∞ÁÇπ",
      prop: "use_place",
      align: "center",
    },
    {
      label: "ÂêçÁß∞",
      prop: "name",
      align: "center",
    },
    {
      label: "ÂûãÂè∑",
      prop: "inst_type_no",
      align: "center",
    },
    {
      label: "Âá∫ÂéÇÁºñÂè∑",
      prop: "productserial_no",
      align: "center",
    },
    {
      label: "ËßÑÊ†º",
      prop: "",
      align: "center",
      children: [
        {
          label: "Max",
          prop: "max_val",
          align: "center",
          cellRenderer: ({ row }) => {
            return (
              <>
                <span>{row.max_val}</span>
                <span>{row.max_unit}</span>
              </>
            );
          },
        },
        {
          label: "e",
          prop: "e_val",
          align: "center",
          cellRenderer: ({ row }) => {
            return (
              <>
                <span>{row.e_val}</span>
                <span>{row.e_unit}</span>
              </>
            );
          },
        },
        {
          label: "d",
          prop: "d_val",
          align: "center",
          cellRenderer: ({ row }) => {
            return (
              <>
                <span>{row.d_val}</span>
                <span>{row.d_unit}</span>
              </>
            );
          },
        },
      ],
    },
    {
      label: "Á†ùÁ†ÅÈáçÈáè",
      prop: "weight_val",
      align: "center",
      cellRenderer: ({ row }) => {
        return (
          <>
            <span>{row.weight_val}</span>
            <span>{row.weight_unit}</span>
          </>
        );
      },
    },
    {
      label: "ÂàõÂª∫‰∫∫",
      prop: "ct_name",
      align: "center",
    },
    {
      label: "ÂàõÂª∫Êó∂Èó¥",
      prop: "create_time",
      align: "center",
      width: 110,
    },
    {
      label: "Êõ¥Êñ∞‰∫∫",
      prop: "up_name",
      align: "center",
    },

    {
      label: "Êìç‰Ωú",
      slot: "operation",
      fixed: "right",
    },
  ];

  /** ÊêúÁ¥¢ÈÖçÁΩÆÈ°π */
  const searchColumns: PlusColumnList = [
    {
      label: "ÂêçÁß∞",
      prop: "name",
      onKeyup: withKeys(() => {
        search();
      }, ["enter"]),
    },
    {
      label: "ÂûãÂè∑",
      prop: "inst_type_no",
      onKeyup: withKeys(() => {
        search();
      }, ["enter"]),
    },
  ];

  const instList = ref<any[]>([]);
  async function getInstMap() {
    const reuslt = await getInstMapApi({ is_open: 1 });
    instList.value = reuslt.data;
  }

  // Êñ∞Â¢ûÂºπÁ™óÁöÑÊï∞ÊçÆ
  const addFormData = ref({
    sort: "", //ÊéíÂ∫èÂè∑
    inst_id: "", //‰ª™Âô®id
    name: "", //ÂêçÁß∞
    productserial_no: "", //Âá∫ÂéÇÁºñÂè∑
    inst_type_no: "", //‰ª™Âô®ÂûãÂè∑
    max_val: "", //maxÂÄº
    max_unit: "", //maxÂçï‰Ωç
    e_val: "", //eÂÄº
    e_unit: "", //eÂçï‰Ωç
    d_val: "", //dÂÄº
    d_unit: "", //dÂçï‰Ωç
    weight_val: "", //ÈáçÈáèÂÄº
    weight_unit: "", //ÈáçÈáèÂçï‰Ωç
    use_place_id: [] as number[],
  });

  const selectNameRef = ref();
  function selectNameChange(val: number) {
    console.log("üöÄ ~ selectNameChange ~ val:", val);

    const item = instList.value.find((item: any) => item.id === val);
    console.log("item", item);
    addFormData.value.inst_type_no = item.inst_type_no;
    addFormData.value.name = item.name;
    addFormData.value.productserial_no = item.productserial_no;
  }

  // Êñ∞Â¢ûÂºπÁ™óÁöÑË°®ÂçïÈ°π
  const addFormColumns: PlusColumnList = [
    {
      label: "ÊéíÂ∫èÂè∑",
      prop: "sort",
    },
    {
      label: "‰ΩøÁî®Âú∞ÁÇπ",
      prop: "use_place_id",
    },
    {
      label: "ÂêçÁß∞",
      prop: "inst_id",
      valueType: "select",
      // options: computed(() => {
      //   return instOptions.value;
      // }),
      renderField: () => {
        return (
          <ElSelect
            v-model={addFormData.value.inst_id}
            ref={selectNameRef}
            style="width:100%"
            filterable={true}
            onChange={selectNameChange}
          >
            {instList.value.map((option) => (
              <ElOption key={option.id} label={option.name} value={option.id} />
            ))}
          </ElSelect>
        );
      },

      // fieldProps: {
      //   onChange: (value: any) => {
      //     const item = instList.value.find((item: any) => item.id === value);
      //     console.log("item", item);
      //     addFormData.value.inst_type_no = item.inst_type_no;
      //     addFormData.value.productserial_no = item.productserial_no;
      //   },
      // },
    },
    {
      label: "ÂûãÂè∑",
      prop: "inst_type_no",
      fieldProps: {
        disabled: true,
        placeholder: "ËØ∑ÈÄâÊã©ÂêçÁß∞",
      },
    },
    {
      label: "Âá∫ÂéÇÁºñÂè∑",
      prop: "productserial_no",
      fieldProps: {
        disabled: true,
        placeholder: "ËØ∑ÈÄâÊã©ÂêçÁß∞",
      },
    },
    {
      label: "Max",
      prop: "max_val",
      fieldSlots: {
        append: () => (
          <>
            <ElSelect style="width:100px" v-model={addFormData.value.max_unit} filterable={true}>
              {unitList.value.map((option) => (
                <ElOption key={option.id} label={option.name} value={option.name} />
              ))}
            </ElSelect>
          </>
        ),
      },
    },
    {
      label: "e",
      prop: "e_val",
      fieldSlots: {
        append: () => (
          <>
            <ElSelect style="width:100px" v-model={addFormData.value.e_unit} filterable={true}>
              {unitList.value.map((option) => (
                <ElOption key={option.id} label={option.name} value={option.name} />
              ))}
            </ElSelect>
          </>
        ),
      },
    },
    {
      label: "d",
      prop: "d_val",
      fieldSlots: {
        append: () => (
          <>
            <ElSelect style="width:100px" v-model={addFormData.value.d_unit} filterable={true}>
              {unitList.value.map((option) => (
                <ElOption key={option.id} label={option.name} value={option.name} />
              ))}
            </ElSelect>
          </>
        ),
      },
    },
    {
      label: "Á†ùÁ†ÅÈáçÈáè",
      prop: "weight_val",
      fieldSlots: {
        append: () => (
          <>
            <ElSelect style="width:100px" v-model={addFormData.value.weight_unit} filterable={true}>
              {unitList.value.map((option) => (
                <ElOption key={option.id} label={option.name} value={option.name} />
              ))}
            </ElSelect>
          </>
        ),
      },
    },
  ];
  // Êñ∞Â¢ûÂºπÁ™óÁöÑÈ™åËØÅËßÑÂàô
  const addFormRules = {
    sort: [
      {
        required: true,
        message: "ËØ∑ËæìÂÖ•ÊéíÂ∫èÂè∑",
      },
    ],
    use_place_id: [
      {
        required: true,
        message: "ËØ∑ÈÄâÊã©‰ΩøÁî®Âú∞ÁÇπ",
      },
    ],
    inst_id: [
      {
        required: true,
        message: "ËØ∑ÈÄâÊã©‰ª™Âô®",
      },
    ],
    productserial_no: [
      {
        required: true,
        validator: (rule: any, value: any, callback: any) => {
          if (!value) {
            if (addFormData.value.inst_id) {
              callback(new Error("ËØ•‰ª™Âô®Êú™ËÆæÁΩÆÂá∫ÂéÇÁºñÂè∑"));
            } else {
              callback(new Error("ËØ∑ÈÄâÊã©‰ª™Âô®"));
            }
          } else {
            callback();
          }
        },
      },
    ],
    inst_type_no: [
      {
        required: true,
        validator: (rule: any, value: any, callback: any) => {
          if (!value) {
            if (addFormData.value.inst_id) {
              callback(new Error("ËØ•‰ª™Âô®Êú™ËÆæÁΩÆ‰ª™Âô®ÂûãÂè∑"));
            } else {
              callback(new Error("ËØ∑ÈÄâÊã©‰ª™Âô®"));
            }
          } else {
            callback();
          }
        },
      },
    ],
    max_val: [
      {
        required: true,
        validator: (rule: any, value: any, callback: any) => {
          if (!value) {
            callback(new Error("ËØ∑ËæìÂÖ•MaxÂÄº"));
          } else {
            if (addFormData.value.max_unit) {
              callback();
            } else {
              callback(new Error("ËØ∑ÈÄâÊã©MaxÂçï‰Ωç"));
            }
          }
        },
      },
    ],
    e_val: [
      {
        required: true,
        validator: (rule: any, value: any, callback: any) => {
          if (!value) {
            callback(new Error("ËØ∑ËæìÂÖ•eÂÄº"));
          } else {
            if (addFormData.value.e_unit) {
              callback();
            } else {
              callback(new Error("ËØ∑ÈÄâÊã©eÂÄºÂçï‰Ωç"));
            }
          }
        },
      },
    ],
    d_val: [
      {
        required: true,
        validator: (rule: any, value: any, callback: any) => {
          if (!value) {
            callback(new Error("ËØ∑ËæìÂÖ•dÂÄº"));
          } else {
            if (addFormData.value.d_unit) {
              callback();
            } else {
              callback(new Error("ËØ∑ÈÄâÊã©dÂÄºÂçï‰Ωç"));
            }
          }
        },
      },
    ],
    weight_val: [
      {
        required: true,
        validator: (rule: any, value: any, callback: any) => {
          if (!value) {
            callback(new Error("ËØ∑ËæìÂÖ•Á†ùÁ†ÅÈáçÈáè"));
          } else {
            if (addFormData.value.weight_unit) {
              callback();
            } else {
              callback(new Error("ËØ∑ÈÄâÊã©Á†ùÁ†ÅÈáçÈáèÂçï‰Ωç"));
            }
          }
        },
      },
    ],
  };
  // Êñ∞Â¢ûÂºπÁ™óÂºÄÂÖ≥
  const addVisible = ref(false);

  return {
    pagination,
    formData,
    columns,
    searchColumns,
    addFormData,
    addFormColumns,
    addFormRules,
    addVisible,
    instList,
    getInstMap,
    placeList,
    unitList,
  };
}
